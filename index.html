<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Idle Village — Chibi Kawaii V18</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff7fb0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
:root{
  --ink:#fff8ff; --mut:#d2d8ef; --card:rgba(10,14,26,.82); --stroke:rgba(255,255,255,.14);
  --gold:#ffd56a; --chakra:#7dd5ff; --magic:#c8a8ff; --gem:#68f0ff; --emblem:#ffde91;
  --safeTop:env(safe-area-inset-top,0px); --safeBottom:env(safe-area-inset-bottom,0px);
  --space:12px;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);-webkit-tap-highlight-color:transparent}
*{box-sizing:border-box}

/* BG */
.bg{position:fixed;inset:0;z-index:0;overflow:hidden}
.bg .sky{position:absolute;inset:0;background:linear-gradient(#a8d8ff,#e6f3ff 60%,#fdf7ff);filter:saturate(1.05)}
.bg .mounts{position:absolute;inset:auto 0 0; height:60%;
  background:
    radial-gradient(80% 60% at 20% 100%, #bde0ff 0%, transparent 60%),
    radial-gradient(100% 70% at 80% 100%, #c7e6ff 0%, transparent 60%),
    linear-gradient(#cde8ff,#cde8ff);
  clip-path:polygon(0 50%,15% 35%,28% 52%,45% 30%,62% 55%,78% 38%,100% 56%,100% 100%,0 100%);
  opacity:.9; filter:contrast(1.05);
}
.bg .temple{position:absolute;left:50%;bottom:22%;width:240px;height:120px;transform:translateX(-50%);opacity:.85;filter:drop-shadow(0 10px 18px rgba(0,0,0,.25))}
.temple .roof{position:absolute;left:0;right:0;top:0;height:36px;background:linear-gradient(#ff9aa9,#ff7fb0);clip-path:polygon(0 100%,12% 40%,50% 0,88% 40%,100% 100%)}
.temple .body{position:absolute;left:16px;right:16px;top:34px;bottom:0;border-radius:10px;background:linear-gradient(#ffe0ec,#ffd2ea);border:2px solid rgba(0,0,0,.1)}
.temple .door{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);width:30px;height:38px;border-radius:6px;background:#6b3d1f;box-shadow:inset 0 0 0 2px rgba(0,0,0,.25)}
.temple .win{position:absolute;top:18px;width:22px;height:16px;border-radius:4px;background:linear-gradient(#fff,#ffe1a0);box-shadow:inset 0 0 0 2px rgba(90,43,40,.3)}
.temple .win.l{left:26px} .temple .win.r{right:26px}

/* Sakura */
.petal{position:absolute;top:-40px;width:14px;height:10px;border-radius:50% 50% 50% 50%/60% 60% 40% 40%;background:#ffc7de;opacity:.9;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
@keyframes fall{0%{transform:translateY(-40px) rotate(0deg)}100%{transform:translateY(110vh) rotate(360deg)}}

/* HUD */
#hud{position:fixed;left:var(--space);right:var(--space);top:calc(10px + var(--safeTop));display:flex;gap:8px;flex-wrap:wrap;align-items:center;background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:8px 10px;z-index:20}
.tag{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,.08);border:1px solid var(--stroke);border-radius:999px;padding:6px 10px;font-weight:900}
.dot{width:14px;height:14px;border-radius:50%}
.dot.gold{background:radial-gradient(circle at 30% 30%,#fff7c8,#ffd56a 60%,#ffaf3a)}
.dot.chakra{background:radial-gradient(circle at 30% 30%,#e7f7ff,#85d6ff 60%,#2aa9ff)}
.dot.magic{background:radial-gradient(circle at 30% 30%,#f1e6ff,#ceb4ff 60%,#8a66ff)}
.dot.gem{background:radial-gradient(circle at 30% 30%,#eaffff,#b8fdff 60%,#5ae9ff)}
.dot.emb{background:radial-gradient(circle at 30% 30%,#fff7d1,#ffde91 60%,#ffba38)}
.flex{flex:1}
#eventBanner{display:flex;gap:8px;align-items:center}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid var(--stroke);font-weight:800}

/* PANELS */
.panel{position:fixed;left:var(--space);right:var(--space);bottom:calc(146px + var(--safeBottom));display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;z-index:10}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
.btn{border:1px solid var(--stroke);border-radius:10px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06));color:#fff;font-weight:900;cursor:pointer}
.btn.pink{background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)),linear-gradient(45deg,#ffb1d8,#ff7fb0)}
.btn.gold{background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)),linear-gradient(45deg,#ffd36e,#ff8f6a);color:#2a1600}
.btn.blue{background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)),linear-gradient(45deg,#8bb1ff,#6a8bff)}
.small{color:var(--mut);font-size:13px}

/* WORLD */
#world{position:fixed;inset:0;z-index:5;pointer-events:none}
.entity{position:absolute;will-change:transform;filter:drop-shadow(0 10px 18px rgba(0,0,0,.35))}
.entity.tap{pointer-events:auto}

/* TABS */
#tabs{position:fixed;left:0;right:0;bottom:0;padding:8px 10px calc(10px + var(--safeBottom));z-index:12;background:linear-gradient(180deg,rgba(7,11,22,0),rgba(7,11,22,.9) 40%,rgba(7,11,22,.96))}
.bar{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.bar button{border:1px solid var(--stroke);border-radius:12px;padding:10px 8px;background:var(--card);color:var(--mut);font-weight:900}
.bar button.active{background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.04));color:#fff}

/* TOASTS + DIALOG */
#toasts{position:fixed;right:12px;top:calc(94px + var(--safeTop));width:min(360px,calc(100% - 24px));z-index:30}
.toast{background:var(--card);border:1px solid var(--stroke);border-left:6px solid #ffd257;border-radius:12px;padding:10px;margin:8px 0;animation:fadein .2s ease,fadeout .5s 2.9s forwards}
@keyframes fadein{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeout{to{opacity:0}}
.dialog{position:fixed;left:0;right:0;bottom:calc(74px + var(--safeBottom));margin:auto;width:min(780px,calc(100% - 24px));background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:14px;z-index:40}
.dialog h3{margin:0 0 8px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid var(--stroke);border-radius:10px;margin:6px 0;background:rgba(255,255,255,.04)}
.progress{height:8px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,#ffd56a,#ff9c39)}

/* === Start Overlay === */
#startOverlay{
  position:fixed; inset:0; z-index:1000;
  display:flex; align-items:center; justify-content:center; flex-direction:column;
  background:linear-gradient(180deg,rgba(10,14,26,.85),rgba(10,14,26,.92));
  text-align:center; padding:24px;
}
#startOverlay h1{margin:0 0 10px; font-size:28px}
#startOverlay p{margin:0 0 16px; color:#d2d8ef}
#startBtn{
  border:1px solid var(--stroke); border-radius:14px; padding:12px 16px;
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)),linear-gradient(45deg,#ffb1d8,#ff7fb0);
  color:#fff; font-weight:900; cursor:pointer
}
#resetBtn{
  position:fixed;right:10px;bottom:78px;z-index:990;border-radius:10px;padding:8px 10px;
  border:1px solid rgba(255,255,255,.25);background:rgba(10,14,26,.82);color:#fff;font-weight:700;cursor:pointer
}
</style>
</head>
<body>

<!-- BG -->
<div class="bg">
  <div class="sky"></div>
  <div class="mounts"></div>
  <div class="temple"><div class="roof"></div><div class="body"><div class="win l"></div><div class="win r"></div><div class="door"></div></div></div>
</div>
<div id="sakura"></div>

<!-- HUD -->
<div id="hud">
  <div class="tag"><span class="dot gold"></span>Or&nbsp;<b id="g">0</b></div>
  <div class="tag"><span class="dot chakra"></span>Chakra&nbsp;<b id="c">0</b></div>
  <div class="tag"><span class="dot magic"></span>Magie&nbsp;<b id="m">0</b></div>
  <div class="tag"><span class="dot gem"></span>Gemmes&nbsp;<b id="j">0</b></div>
  <div class="tag"><span class="dot emb"></span>Emblèmes&nbsp;<b id="e">0</b></div>
  <div class="flex"></div>
  <div id="eventBanner" class="small"></div>
</div>

<!-- PANELS -->
<div class="panel">
  <div class="card">
    <h3>Village</h3>
    <p class="small">Construis & améliore (Or/Chakra/Magie). Les gemmes servent au portail.</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" onclick="build('Maison')">Maison kawaii</button>
      <button class="btn" onclick="build('Dojo')">Dojo mignon</button>
      <button class="btn" onclick="build('Temple')">Temple chibi</button>
      <button class="btn gold" onclick="meditate()">🧘 Méditer</button>
    </div>
  </div>
  <div class="card">
    <h3>Invocation</h3>
    <p class="small">Portails : Permanent / Spécial (taux ↑ vedette) — <b>45💎</b> la x10</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn pink" onclick="openGacha()">✨ Ouvrir les portails</button>
      <button class="btn blue" onclick="openResearch()">🔬 Recherche</button>
    </div>
  </div>
</div>

<!-- WORLD -->
<div id="world"></div>

<!-- TABS -->
<div id="tabs">
  <div class="bar">
    <button class="active">Village</button>
    <button onclick="openHeroes()">Héros</button>
    <button onclick="openQuests()">Quêtes</button>
    <button onclick="openAchievements()">Succès</button>
    <button onclick="openPrestige()">Ascension</button>
  </div>
</div>

<!-- TOASTS / DIALOG -->
<div id="toasts" aria-live="polite"></div>
<div id="dialog" class="dialog" style="display:none"></div>

<!-- === START OVERLAY === -->
<div id="startOverlay">
  <h1>Idle Village — Chibi Kawaii</h1>
  <p>Appuie sur “Démarrer” pour activer l’audio et lancer le jeu</p>
  <button id="startBtn">Démarrer</button>
</div>

<!-- === RESET BUTTON === -->
<button id="resetBtn" title="Réinitialiser la partie">⚙️ Réinitialiser</button>

<script>
/* ===== Shorthands ===== */
const $=id=>document.getElementById(id);
const toast=m=>{const d=document.createElement('div');d.className='toast';d.textContent=m;$('toasts').appendChild(d);setTimeout(()=>d.remove(),3200)};
const world=$('world'), sak=$('sakura'), dialog=$('dialog');
function setPos(el,x,y){ el.style.transform=`translate(${x}px,${y}px)`; }

/* ===== Sakura ===== */
function spawnPetal(){ const p=document.createElement('div'); p.className='petal'; p.style.left=Math.random()*100+'%'; p.style.animation=`fall ${6+Math.random()*6}s linear`; sak.appendChild(p); setTimeout(()=>p.remove(),13000); }
for(let i=0;i<24;i++) setTimeout(spawnPetal,Math.random()*3000); setInterval(spawnPetal,700);

/* ===== WebAudio unlock ===== */
let audioCtx=null; function ping(freq=880,ms=120){
  try{ audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.value=0.06; o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+ms/1000); o.stop(audioCtx.currentTime+ms/1000);
  }catch(e){}
}
$('startBtn').addEventListener('click',()=>{
  try{
    audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    const s=audioCtx.createOscillator(), g=audioCtx.createGain();
    g.gain.value=0.0001; s.connect(g); g.connect(audioCtx.destination); s.start(); s.stop(audioCtx.currentTime+0.05);
  }catch(e){}
  $('startOverlay').style.display='none';
  startGame();
});

/* ===== RESET button ===== */
$('resetBtn').onclick=()=>{
  localStorage.removeItem('idle_chibi_v18');
  location.reload(); // le bonus de départ sera ré-appliqué au premier lancement
};

/* ===== Game state ===== */
let gold=0, chakra=0, magic=0, gems=90, emblems=0, pity=0;
const g=$('g'), c=$('c'), m=$('m'), j=$('j'), e=$('e');
const buildings=[], heroes=[];
const KEY='idle_chibi_v18';
function updateHUD(){ g.textContent=gold|0; c.textContent=chakra|0; m.textContent=magic|0; j.textContent=gems|0; e.textContent=emblems|0; }

/* ===== Buildings visuals ===== */
const BDATA={
  Maison:{ w:160,h:120, cost:{g:80,c:10,m:0}, mult:1.44, prod:{g:1.2,c:0.2,m:0.05},
    svg:`<svg width="160" height="120" viewBox="0 0 160 120" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="r" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#ff9aa9"/><stop offset="1" stop-color="#ff7fb0"/></linearGradient>
      <linearGradient id="b" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#ffe0ec"/><stop offset="1" stop-color="#ffd2ea"/></linearGradient></defs>
      <path d="M8,60 L40,28 L80,14 L120,28 L152,60 Z" fill="url(#r)" stroke="rgba(0,0,0,.2)"/>
      <rect x="20" y="60" width="120" height="52" rx="14" fill="url(#b)" stroke="rgba(0,0,0,.12)"/>
      <rect x="38" y="76" width="24" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="98" y="76" width="24" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="74" y="84" width="14" height="24" rx="3" fill="#6b3d1f"/>
    </svg>`},
  Dojo:{ w:160,h:120, cost:{g:120,c:40,m:10}, mult:1.48, prod:{g:0.7,c:0.9,m:0.12},
    svg:`<svg width="160" height="120" viewBox="0 0 160 120" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="r" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#ffcf6a"/><stop offset="1" stop-color="#ff8f6a"/></linearGradient>
      <linearGradient id="b" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#fff0d8"/><stop offset="1" stop-color="#ffe5c2"/></linearGradient></defs>
      <path d="M8,60 L40,32 L80,18 L120,32 L152,60 Z" fill="url(#r)" stroke="rgba(0,0,0,.2)"/>
      <rect x="20" y="60" width="120" height="52" rx="14" fill="url(#b)" stroke="rgba(0,0,0,.12)"/>
      <rect x="46" y="76" width="20" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="94" y="76" width="20" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="74" y="84" width="14" height="24" rx="3" fill="#6b3d1f"/>
    </svg>`},
  Temple:{ w:160,h:120, cost:{g:90,c:70,m:30}, mult:1.52, prod:{g:0.35,c:1.25,m:0.3},
    svg:`<svg width="160" height="120" viewBox="0 0 160 120" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="r" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#6aa7ff"/><stop offset="1" stop-color="#6a7dff"/></linearGradient>
      <linearGradient id="b" x1="0" y="0" x2="0" y2="1"><stop offset="0" stop-color="#e5f1ff"/><stop offset="1" stop-color="#dfe7ff"/></linearGradient></defs>
      <path d="M8,60 L40,30 L80,16 L120,30 L152,60 Z" fill="url(#r)" stroke="rgba(0,0,0,.2)"/>
      <rect x="20" y="60" width="120" height="52" rx="14" fill="url(#b)" stroke="rgba(0,0,0,.12)"/>
      <rect x="40" y="76" width="24" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="96" y="76" width="24" height="18" rx="4" fill="#fff" opacity=".9"/>
      <rect x="74" y="84" width="14" height="24" rx="3" fill="#6b3d1f"/>
    </svg>`}
};

/* ===== Heroes/Gacha ===== */
const HPOOL=[
  {name:'Samurai',     c1:'#ff9aa9', c2:'#ff7fb0', base:{g:1.25,c:0,m:0}},
  {name:'Ninja',       c1:'#8cc9ff', c2:'#4aa6ff', base:{g:0.6,c:0.6,m:0}},
  {name:'Mage',        c1:'#d8c6ff', c2:'#a78bfa', base:{g:0,  c:0.25,m:0.85}},
  {name:'Onna-Bugeisha', c1:'#ffb3c6', c2:'#ff7aa8', base:{g:1.1,c:0.2,m:0.2}},
  {name:'Kunoichi',    c1:'#b3f0ff', c2:'#6fd1ff', base:{g:0.5,c:0.9,m:0}},
  {name:'Moine',       c1:'#ffd89c', c2:'#ffc16a', base:{g:0.4,c:0.5,m:0.6}},
  {name:'Invocateur Kitsune', c1:'#ffe6b8', c2:'#ffcf88', base:{g:0.3,c:0.3,m:1.0}},
];
const RAR=[{k:'C',n:'Commun',w:70,m:1.0},{k:'R',n:'Rare',w:22,m:1.25},{k:'E',n:'Épique',w:7,m:1.6},{k:'L',n:'Légendaire',w:1,m:2.3}];

/* ===== Skins ===== */
const ownedSkins=new Set();

/* ===== Events ===== */
function now(){ return new Date(); }
function isWeekendSakura(d){ const day=d.getDay(); const h=d.getHours(); if(day===5 && h>=18) return true; if(day===6 || day===0) return true; if(day===1 && h<6) return true; return false; }
function isFestivalLanternes(d){ const date=d.getDate(); return date>=15 && date<=17; }
function eventEffects(){ const d=now(); return { pityBoost: isWeekendSakura(d)? 0.5 : 0, prodMult:  isFestivalLanternes(d)? 2.0 : 1.0 }; }
function renderEventBanner(){ const eff=eventEffects(); const parts=[]; if(eff.pityBoost>0) parts.push('🌸 Weekend Sakura : +50% Rare+'); if(eff.prodMult>1) parts.push('🏮 Festival des Lanternes : production ×'+eff.prodMult); $('eventBanner').innerHTML = parts.length? parts.map(p=>'<span class="badge">'+p+'</span>').join(' ') : '<span class="small">Aucun événement en cours</span>'; }
setInterval(renderEventBanner, 1000); renderEventBanner();

/* ===== Helpers ===== */
function rnd(a,b){ return Math.random()*(b-a)+a; }
function makeEntity(svg,w,h){ const wrap=document.createElement('div'); wrap.className='entity tap'; wrap.style.width=w+'px'; wrap.style.height=h+'px'; wrap.innerHTML=svg; world.appendChild(wrap); return wrap; }

/* ===== Buildings ===== */
function costOf(type,lvl){ const b=BDATA[type]; const k=Math.pow(b.mult,lvl); return {gold:Math.ceil(b.cost.g*k), chakra:Math.ceil(b.cost.c*k), magic:Math.ceil(b.cost.m*k)}; }
function build(type){
  const c=costOf(type,0); if(gold<c.gold||chakra<c.chakra||magic<c.magic){ toast('Coût '+type+': 💰'+c.gold+' 🔮'+c.chakra+' ✨'+c.magic); return; }
  gold-=c.gold; chakra-=c.chakra; magic-=c.magic; updateHUD();
  const b=BDATA[type]; const el=makeEntity(b.svg,b.w,b.h);
  const x=innerWidth*0.2+rnd(0,innerWidth*0.6), y=innerHeight*0.58+rnd(-4,42); setPos(el,x,y);
  const obj={x,y,lvl:1,type,el,base:b}; buildings.push(obj);
  el.addEventListener('click',()=>upgrade(el));
  el.animate([{transform:el.style.transform+' scale(0.9)'},{transform:el.style.transform+' scale(1)'}],{duration:220,easing:'ease-out'});
  ping(660); toast(type+' construit !'); saveSoon(); bumpQuest('build');
}
function upgrade(el){
  const b=buildings.find(z=>z.el===el); if(!b) return; const c=costOf(b.type,b.lvl);
  if(gold<c.gold||chakra<c.chakra||magic<c.magic){ toast('Ressources insuffisantes'); return; }
  gold-=c.gold; chakra-=c.chakra; magic-=c.magic; b.lvl++; updateHUD();
  el.animate([{transform:el.style.transform+' scale(1)'},{transform:el.style.transform+' scale(1.08)'},{transform:el.style.transform+' scale(1)'}],{duration:280});
  ping(520); toast(b.type+' → niv '+b.lvl); saveSoon(); bumpQuest('upgrade');
}

/* ===== Gacha ===== */
const FEATURED='Onna-Bugeisha';
function pickR(base){ const tot=base.reduce((s,r)=>s+r.w,0); let x=Math.random()*tot; for(const r of base){ x-=r.w; if(x<=0) return r; } return base[0]; }
function addHero(r, forcedName=null){
  const list = forcedName? HPOOL.filter(h=>h.name===forcedName) : HPOOL;
  const t=list[Math.random()*list.length|0];
  const svg=`<svg width="128" height="128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
  <defs><linearGradient id="h" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="${t.c1}"/><stop offset="1" stop-color="${t.c2}"/></linearGradient></defs>
  <circle cx="64" cy="58" r="42" fill="url(#h)"/><circle cx="64" cy="64" r="30" fill="#ffd9b3"/>
  <ellipse cx="48" cy="64" rx="8" ry="10" fill="#111"/><ellipse cx="80" cy="64" rx="8" ry="10" fill="#111"/>
  <circle cx="46" cy="62" r="3.5" fill="#fff"/><circle cx="78" cy="62" r="3.5" fill="#fff"/>
  <rect x="28" y="30" width="72" height="12" rx="6" fill="${r.k==='L'?'#ffe082': r.k==='E'?'#d1c4e9': r.k==='R'?'#b3e5fc':'#e5e7eb'}" />
  </svg>`;
  const el=makeEntity(svg,128,128);
  const x=innerWidth*0.2+rnd(0,innerWidth*0.6), y=innerHeight*0.62+rnd(-10,30); setPos(el,x,y);
  heroes.push({x,y,lvl:1,type:t,rar:r,prod:{g:+(t.base.g*r.m).toFixed(2), c:+(t.base.c*r.m).toFixed(2), m:+(t.base.m*r.m).toFixed(2)},el});
  el.animate([{transform:el.style.transform+' scale(0.8)'},{transform:el.style.transform+' scale(1)'}],{duration:220,easing:'ease-out'});
}
function portalWeights(kind){
  const eff=eventEffects(); let base=RAR.map(r=>({...r}));
  if(eff.pityBoost>0){ base=base.map(r=> r.k==='C'? {...r,w:r.w*0.7} : {...r,w:r.w*1.5}); }
  if(kind==='feat'){ base=base.map(r=> r.k==='E'||r.k==='L' ? {...r,w:r.w*1.6} : r); }
  return base;
}
function openGacha(){
  const eff=eventEffects();
  const html=
    '<div class="row"><div><b>Portail Permanent</b><div class="small">Taux standard. Pity 10 → ≥ Rare.</div></div>'+
      '<button class="btn pink" onclick="summon10(\\'perm\\')">x10 (45💎)</button></div>'+
    '<div class="row"><div><b>Portail Spécial</b><div class="small">Vedette : <b>'+FEATURED+'</b> (taux ↑). '+(eff.pityBoost>0?'<span class="badge">Événement Sakura: +50% Rare+</span>':'')+'</div></div>'+
      '<button class="btn pink" onclick="summon10(\\'feat\\')">x10 (45💎)</button></div>'+
    '<div class="row"><div><b>Skins kawaii</b><div class="small">Purement cosmétiques (collection)</div></div>'+
      '<button class="btn blue" onclick="openSkins()">Voir la collection</button></div>';
  showDialog('Portails', html);
}
function summon10(kind='perm'){
  if(gems<45){ toast('Pas assez de gemmes (45)'); return; }
  gems-=45; updateHUD();
  const fx=document.createElement('div'); fx.style.position='fixed'; fx.style.left='50%'; fx.style.top='55%'; fx.style.width='140px'; fx.style.height='140px'; fx.style.margin='-70px 0 0 -70px';
  fx.style.border='6px solid rgba(255,255,255,.85)'; fx.style.borderRadius='50%'; fx.style.boxShadow='0 0 44px rgba(255,180,220,.7), inset 0 0 40px rgba(120,180,255,.7)'; fx.style.zIndex=50; document.body.appendChild(fx);
  fx.animate([{transform:'scale(0.8)',opacity:.9},{transform:'scale(1.4)',opacity:0}],{duration:900,easing:'ease-out'}); setTimeout(()=>fx.remove(),920);

  const weights=portalWeights(kind);
  let gotRare=false; const pulls=[];
  for(let i=0;i<10;i++){
    let r=pickR(weights); pity++;
    if(pity>=10 && r.k==='C'){ r={...RAR[1]}; pity=0; }
    if(r.k!=='C') pity=0, gotRare=true;
    pulls.push(r);
  }
  if(!gotRare) pulls[9]=RAR[1];
  pulls.forEach((r,i)=>{ setTimeout(()=>{ if(kind==='feat' && (r.k==='E'||r.k==='L') && Math.random()<0.45){ addHero(r, FEATURED); } else { addHero(r); } }, 140*i); });
  setTimeout(()=>{ toast('Invocation x10 ✨'); saveSoon(); bumpQuest('summon'); }, 1600);
}

/* ===== Skins (UI minimal) ===== */
function openSkins(){
  const items=[
    {hero:'Onna-Bugeisha', name:"Kimono d'été"},
    {hero:'Kunoichi',      name:"Tenue ninja nocturne"},
    {hero:'Mage',          name:"Lapin magique"},
    {hero:'Invocateur Kitsune', name:"Masque cérémoniel"},
    {hero:'Samurai',       name:"Armure brillante"}
  ].map(s=>{
    const id=s.hero+'|'+s.name; const has=ownedSkins.has(id);
    return '<div class="row"><div><b>'+s.hero+'</b> — '+s.name+'</div>'+
      '<button class="btn '+(has?'':'gold')+'" '+(has?'disabled':'')+' onclick="unlockSkin(\\''+id+'\\')">'+(has?'Obtenu':'Débloquer (10💎)')+'</button></div>';
  }).join('');
  showDialog('Collection de skins', items);
}
function unlockSkin(id){
  if(ownedSkins.has(id)) return;
  if(gems<10){ toast('Pas assez de gemmes'); return; }
  gems-=10; ownedSkins.add(id); updateHUD(); toast('Skin débloqué ✨'); openSkins(); saveSoon();
}

/* ===== Quêtes / Succès / Recherche / Prestige ===== */
let quests=[]; function newDailyQuests(){
  quests=[
    {id:'q_build',name:'Construire 1 bâtiment',type:'build',target:1,progress:0,reward:{gems:10}},
    {id:'q_upgrade',name:'Améliorer 2 fois',type:'upgrade',target:2,progress:0,reward:{gold:300}},
    {id:'q_summon',name:'Faire 1 invocation',type:'summon',target:1,progress:0,reward:{chakra:120}}
  ];
}
function bumpQuest(type){ quests.forEach(q=>{ if(q.type===type && q.progress<q.target){ q.progress++; if(q.progress===q.target) toast('Quête : '+q.name); }}); saveSoon(); }
function openQuests(){
  showDialog('Quêtes quotidiennes', quests.map(q=>{
    const pct=Math.min(100, Math.round(100*q.progress/q.target));
    const reward=q.reward.gems? (q.reward.gems+'💎') : q.reward.gold? (q.reward.gold+'💰') : q.reward.chakra? (q.reward.chakra+'🔮') : (q.reward.magic+'✨');
    return '<div class="row"><div><b>'+q.name+'</b><div class="progress" style="width:180px"><i style="width:'+pct+'%"></i></div><div class="small">Récompense : '+reward+'</div></div>'+
      '<button class="btn" '+(q.progress<q.target?'disabled':'')+' onclick="claimQuest(\\''+q.id+'\\')">Récupérer</button></div>';
  }).join('')+'<div class="small" style="margin-top:6px">Renouvelées chaque jour.</div>');
}
function claimQuest(id){
  const q=quests.find(x=>x.id===id); if(!q||q.progress<q.target) return;
  if(q.reward.gems) gems+=q.reward.gems; if(q.reward.gold) gold+=q.reward.gold; if(q.reward.chakra) chakra+=q.reward.chakra; if(q.reward.magic) magic+=q.reward.magic;
  quests=quests.filter(x=>x.id!==id); updateHUD(); toast('Récompense reçue'); saveSoon(); openQuests();
}
const ACH=[{id:'a_g1000', name:'Touche-à-tout', desc:'Atteindre 1 000 Or', test:()=>gold>=1000, reward:{gems:10}},
           {id:'a_c500',  name:'Canaliseur',    desc:'Atteindre 500 Chakra', test:()=>chakra>=500, reward:{gems:10}},
           {id:'a_m300',  name:'Arcaniste',     desc:'Atteindre 300 Magie', test:()=>magic>=300, reward:{gems:10}},
           {id:'a_10b',   name:'Villageon',     desc:'10 niveaux cumulés de bâtiments', test:()=>buildings.reduce((s,b)=>s+b.lvl,0)>=10, reward:{gems:20}}];
const achieved=new Set();
function openAchievements(){
  ACH.forEach(a=>{ if(!achieved.has(a.id)&&a.test()){ achieved.add(a.id); gems+=a.reward.gems||0; toast('Succès : '+a.name+' (+'+(a.reward.gems||0)+'💎)'); }});
  showDialog('Succès', ACH.map(a=>'<div class="row"><div><b>'+a.name+'</b><div class="small">'+a.desc+'</div></div><span class="badge" style="background:'+(achieved.has(a.id)?'rgba(156,242,159,.2)':'rgba(255,255,255,.1)')+'">'+(achieved.has(a.id)?'Terminé':'En cours')+'</span></div>').join(''));
  updateHUD(); saveSoon();
}
const TECH=[{id:'eco1', name:'Économie I', desc:'+25% Or', costG:400,costC:60,costM:30, mult:{g:1.25}},
            {id:'chi1', name:'Chakra I',   desc:'+25% Chakra', costG:300,costC:120,costM:40, mult:{c:1.25}},
            {id:'mag1', name:'Magie I',    desc:'+25% Magie', costG:300,costC:70,costM:120, mult:{m:1.25}},
            {id:'eco2', name:'Économie II',desc:'+40% Or', costG:1200,costC:240,costM:120, mult:{g:1.4}}];
const ownedTech=new Set();
function openResearch(){
  showDialog('Recherche', TECH.map(t=>{
    const owned=ownedTech.has(t.id);
    return '<div class="row"><div><b>'+t.name+'</b><div class="small">'+t.desc+'</div><div class="small">Coûts : 💰'+t.costG+' 🔮'+t.costC+' ✨'+t.costM+'</div></div>'+
      '<button class="btn '+(owned?'':'blue')+'" '+(owned?'disabled':'')+' onclick="buyTech(\\''+t.id+'\\')">'+(owned?'Acheté':'Acheter')+'</button></div>';
  }).join(''));
}
function buyTech(id){
  const t=TECH.find(x=>x.id===id); if(!t||ownedTech.has(id)) return;
  if(gold<t.costG||chakra<t.costC||magic<t.costM){ toast('Ressources insuffisantes'); return; }
  gold-=t.costG; chakra-=t.costC; magic-=t.costM; ownedTech.add(id); updateHUD(); toast('Recherche débloquée : '+t.name); saveSoon(); openResearch();
}

/* ===== Production / Prestige ===== */
function totalMult(){
  let mg=1, mc=1, mm=1;
  ownedTech.forEach(id=>{ const t=TECH.find(x=>x.id===id); if(!t) return; if(t.mult.g) mg*=t.mult.g; if(t.mult.c) mc*=t.mult.c; if(t.mult.m) mm*=t.mult.m; });
  mg*= (1 + emblems*0.15); mc*= (1 + emblems*0.15); mm*= (1 + emblems*0.15);
  const eff=eventEffects(); mg*=eff.prodMult; mc*=eff.prodMult; mm*=eff.prodMult;
  return {mg,mc,mm};
}
function meditate(){ let gainC=12; buildings.forEach(b=>{ if(b.type==='Dojo') gainC+=2; if(b.type==='Temple') gainC+=4; }); chakra+=Math.round(gainC); updateHUD(); toast('Méditation : 🔮 +'+Math.round(gainC)); saveSoon(); }
function tick(){
  const base={g:1,c:.5,m:.2};
  buildings.forEach(b=>{ base.g+=b.base.prod.g*b.lvl; base.c+=b.base.prod.c*b.lvl; base.m+=b.base.prod.m*b.lvl; });
  heroes.forEach(h=>{ base.g+=h.prod.g*h.lvl; base.c+=h.prod.c*h.lvl; base.m+=h.prod.m*h.lvl; });
  const mult=totalMult(); gold+=Math.floor(base.g*mult.mg); chakra+=Math.floor(base.c*mult.mc); magic+=Math.floor(base.m*mult.mm);
  updateHUD(); saveSoon();
}
setInterval(tick,5000);
function calcPrestigeGain(){ const score = gold + chakra*2 + magic*3; return Math.floor(score/18000); }
function openPrestige(){
  const gain=calcPrestigeGain();
  showDialog('Ascension (Prestige)',
    '<p class="small">Réinitialise Or/Chakra/Magie, bâtiments et héros. Conserve gemmes, recherches, succès, skins. Accorde des <b>Emblèmes</b> (+15% prod globale chacun).</p>'+
    '<div class="row"><div><b>Emblèmes potentiels</b></div><div class="badge">'+gain+'</div></div>'+
    '<div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="hideDialog()">Annuler</button><button class="btn gold" onclick="doPrestige()">Ascension</button></div>'
  );
}
function doPrestige(){ const gain=calcPrestigeGain(); if(gain<=0){ toast('Progresse encore avant l’Ascension ✨'); hideDialog(); return; }
  emblems+=gain; gold=0; chakra=0; magic=0; pity=0;
  buildings.splice(0).forEach(b=>b.el.remove()); heroes.splice(0).forEach(h=>h.el.remove());
  hideDialog(); updateHUD(); toast('Ascension +'+gain+' Emblème(s) 🏵️'); saveSoon();
}

/* ===== Heroes list ===== */
function openHeroes(){
  showDialog('Héros', heroes.length? heroes.map(h=>
    '<div class="row"><div><b>'+h.type.name+'</b> <span class="badge">'+h.rar.n+'</span><div class="small">Prod: 💰'+h.prod.g+' 🔮'+h.prod.c+' ✨'+h.prod.m+'</div></div><div class="badge">Niv '+h.lvl+'</div></div>'
  ).join('') : '<p class="small">Pas encore de héros. Essaye le <b>Portail</b> !</p>');
}

/* ===== Dialog helpers ===== */
function showDialog(title, html){ dialog.style.display='block'; dialog.innerHTML='<h3>'+title+'</h3>'+html; }
function hideDialog(){ dialog.style.display='none'; dialog.innerHTML=''; }

/* ===== Save/Load & Daily ===== */
const achieved=new Set(); const ownedTech=new Set();
let savePending=false;
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }
function saveSoon(){ if(savePending) return; savePending=true; setTimeout(()=>{ try{
  localStorage.setItem(KEY, JSON.stringify({
    gold, chakra, magic, gems, emblems, pity,
    buildings: buildings.map(b=>({x:b.x,y:b.y,lvl:b.lvl,type:b.type})),
    heroes: heroes.map(h=>({x:h.x,y:h.y,lvl:h.lvl,type:h.type.name,rar:h.rar.k})),
    tech:[...ownedTech], achieved:[...achieved], quests, day: todayKey(), skins:[...ownedSkins], time: Date.now()
  }));
} catch(e){} savePending=false; },600); }

function load(){
  const raw=localStorage.getItem(KEY); if(!raw){ newDailyQuests(); startBonus(); return; }
  try{
    const d=JSON.parse(raw);
    gold=d.gold||0; chakra=d.chakra||0; magic=d.magic||0; gems=d.gems||0; emblems=d.emblems||0; pity=d.pity||0;
    (d.tech||[]).forEach(t=>ownedTech.add(t)); (d.achieved||[]).forEach(a=>achieved.add(a)); (d.skins||[]).forEach(s=>ownedSkins.add(s));
    if(d.day!==todayKey()) newDailyQuests(); else quests=d.quests||[], quests.forEach(q=>q.progress??=0);
    (d.buildings||[]).forEach(b=>{ const def=BDATA[b.type]||BDATA.Maison; const el=makeEntity(def.svg,def.w,def.h); setPos(el,b.x,b.y); const obj={x:b.x,y:b.y,lvl:b.lvl,type:b.type,el,base:def}; buildings.push(obj); el.addEventListener('click',()=>upgrade(el)); });
    (d.heroes||[]).forEach(h=>{ addHero(RAR.find(r=>r.k===h.rar)||RAR[0]); });
    if(d.time){ const ms=Math.min(Date.now()-d.time,8*3600*1000); const cycles=Math.floor(ms/5000); for(let i=0;i<cycles;i++) tick(); toast('Production offline '+(ms/3600000).toFixed(2)+'h'); }
  }catch(e){ console.warn(e); newDailyQuests(); }
  updateHUD();
}
function startBonus(){ gold+=1200; chakra+=360; magic+=180; gems+=120; updateHUD(); toast('Bonus départ : 💰1200 🔮360 ✨180 💎120'); }

/* ===== Start game after overlay ===== */
function startGame(){
  renderEventBanner();
  load();
}

/* ===== SW PWA ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(()=>{});
  });
}
</script>
</body>
</html>
